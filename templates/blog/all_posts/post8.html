{% extends 'blog/all_posts/base_post.html' %}

{% load static %}

{% block post_title %}
    <a href="{% url 'blog:all-posts' %}" class="font_kor">메모리 구조</a>
{% endblock post_title %}

{% block post_content %}

    {% block post_date %}
        <div class="container w-1/2 mx-auto mb-10 post_date">[ Sept 18, 2021 ]</div>    
    {% endblock post_date %}

    <main class="container w-1/2 mx-auto font_kor">
        <div class="post_text">
            <li>흔히 메모리라고 하면 RAM을 지칭함</li>
            <li>메모리와 코딩의 관계</li>
            <p class="ml-7">⇒ 한정된 자원 안에서 효율적으로 프로그램이 실행될 수 있도록 하기 위해서는 기본적으로 메모리에 대한 이해 필요</p>
        </div>
        <div id="메모리의구조">
            <div class="post_heading">메모리의 구조(Memory Structure)</div>
            <div class="post_text">
                <li>프로그래밍 언어(C, C++, Java 등)의 코딩을 통해 만들어 진 실행파일을 실행하면 코드에서 작성한 동작에 따라 메모리에 데이터들을 쓰고 읽음</li>
                <li>실행파일의 실행과정</li>
                <div class="ml-7">
                    <p>1. 실행파일을 만들어 실행파일로 디스크에 저장</p>
                    <p>2. 사용자가 실행파일을 더블클릭(실행) ⇒ 운영체제에 실행파일을 실행하도록 요청</p>
                    <p>3. 운영체제는 프로그램의 정보들을 읽고 메인 메모리에 공간을 할당</p>
                    <p>4. 프로그램의 코드(변수, 함수 등)들을 메모리에 읽고 쓰면서 동작</p>
                </div>
            </div>
            <div class="post_subheading">메모리 구조의 4가지 영역</div>
            <div class="flex justify-center mb-6"><img src="{% static 'img/sourcecode/post8-1.png' %}" class="w-1/3"></div>
            <div class="post_text">
                <p>⇒ 각 언어마다 조금씩 차이는 있지만 전체적인 구조는 아래와 같이 4가지 영역으로 구분됨</p>
            </div>
            <div class="post_text">
                <p class="font-bold">[ Text ]</p>
                <li>코드를 실행하기 위해 저장되어있는 영역</li>
                <li>프로그램을 실행시키기 위해 구성되는 것들이 저장되는 영역 (= 코드 영역)</li>
                <li>한마디로 명령문들이 저장되는 것인데, 제어문, 함수, 상수들이 이 영역에 저장됨</li>
            </div>
            <div class="post_text">
                <p class="font-bold">[ Data ]</p>
                <li>전역변수, 정적변수 등이 저장되는 공간</li>
                <li>보통 메인(main)함수 전(프로그램 실행 전)에 선언되어 프로그램이 끝날 때까지 메모리에 남아있는 변수</li>
                <li>좀 더 구체적으로 말하자면 Data영역도 크게 두 가지로 나뉨</li>
                <p class="ml-7">1. 초기화 된 변수 영역(initialized data segment)</p>
                <p class="ml-7">2. 초기화되지 않은 변수 영역(uninitialized data segment; BSS(Block Started by Symbol))</p>
            </div>
            <div class="post_text">
                <p class="font-bold">[ Heap ]</p>
                <li>사용자에 의해 관리되는 영역</li>
                <li>동적으로 할당할 변수</li>
                <li>Java나 C++에서 new 연산자로 생성하는 경우 또는 class, 참조 변수들도 Heap영역에 차지</li>
                <li>언어마다 조금씩 상이 → '동적 할당 영역'이라고 알면 됨</li>
                <li>Heap 영역은 낮은 주소에서 높은 주소로 할당 (적재)</li>
            </div>
            <div class="post_text">
                <p class="font-bold">[ Stack ]</p>
                <li>함수를 호출할 때 지역변수, 매개변수들이 저장되는 공간</li>
                <li>메인(main) 함수 안에서의 변수들도 당연히 포함됨 → 함수가 종료되면 해당 함수에 할당된 변수들을 메모리에서 해제</li>
                <li>함수를 '재귀' 호출시 재귀가 깊어져 Stack Overflow 발생 → 재귀를 반복적으로 호출하면서 Stack 메모리 영역에 해당 함수의 지역변수, 매개변수들이 계속 할당되다가 OS에서 할당해준 Stack영역의 메모리 영역을 넘어버리면 발생하는 오류</li>
                <li>Stack영역은 Heap영역과 반대로 높은 주소에서 낮은 주소로 메모리에 할당</li>
            </div>
        </div>
        <div id="메모리주소">
            <div class="post_heading">메모리 주소 (Memory Address)</div>
            <img src="{% static 'img/sourcecode/post8-2.png' %}">
            <div class="post_text">
                <li>Window 운영체제 : x86(32비트) 또는 x64(64비트) → 비트의 너비(폭)</li>
                <p class="ml-7">⇒ 64bit 운영체제 : 데이터 처리 단위가 더 많다보니 당연히 CPU 처리도 고속화 되고, 새로운 명령어들도 만들 수 있음. 그렇다보니 그렇다보니 64bit 운영체제에서는 32bit프로그램을 돌릴 수가 있지만, 32bit에서는 64bit용 프로그램을 돌릴 수가 없음</p>
            </div>
            <div class="post_subheading">32bit 운영체제와 64bit 운영체제</div>
            <div class="post_text">
                <p>⇒ 메모리 한 칸은 1바이트 크기를 가짐 (메모리의 최소 단위)</p>
                <p class="font-bold">< 32bit 운영체제 ></p>
                <li>메모리 주소의 길이 : 32비트</li>
                <li>32비트 = 2^32 = 4,294,967,296</li>
                <li>총 4,294,967,296개의 메모리 주소가 있으며 이는 4,294,967,296개의 바이트를 인식할 수 있다는 것을 의미함</li>
                <p class="ml-7">⇒ 즉 메모리의 최대 크기는 4,294,967,296 byte = 4GB</p>
                <p class="ml-11">과거 32비트 운영체제에서는 램을 최대 4GB 밖에 설치하지 못함</p>
                <p class="font-bold">< 64bit 운영체제 ></p>
                <li>메모리 주소의 길이 : 64비트</li>
                <li>64비트 = 2^64 = 18,446,744,073,709,551,616</li>
                <li>총 18,446,744,073,709,551,616개의 메모리 주소가 있으며 이는 18,446,744,073,709,551,616개의 바이트를 인식할 수 있음 </li>
                <p class="ml-7">⇒ 18,446,744,073,709,551,616 byte = 16EB(엑사바이트) = 16384TB(테라바이트)</p>
                <p class="ml-11">이론적으로는 램을 16EB까지 설치 가능하지만 메인보드에서도 지원 한계량이 있어서 대부분 32GB 또는 64GB까지 지원</p>
            </div>
            <div class="post_box -mt-5 mb-6">
                <p class="font-bold">< C의 포인터 ></p>
                <p>포인터는 '주소'를 가리키기 때문에 운영체제가 몇비트냐에 따라 주소의 길이가 달라짐</p>
                <li>32bit : 주소의 길이 4바이트, 포인터의 크기 4바이트</li>
                <li>64bit : 주소의 길이가 8바이트, 포인터의 크기 8바이트</li>
                <p class="ml-7">⇒ 이는 1byte가 8bit인 경우</p>
            </div>
        </div>
        <div id="코드의메모리영역">
            <div class="post_heading">코드의 메모리 영역 (Code and Memory Layout)</div>
            <img src="{% static 'img/sourcecode/post8-3.png' %}">
            <div class="post_text">
                <li><span class="font-bold">상수, 함수</span> : Text 영역</li>
                <li><span class="font-bold">전역, 정적변수</span> : Data 영역</li>
                <li><span class="font-bold">지역변수</span> :  Stack 영역</li>
                <li><span class="font-bold">동적할당이 되는 변수</span> : Heap영역 (malloc 함수는 런타임(실행중)에 메모리를 동적으로 할당할 수 있는 함수)</li>
                <li>위 4개의 영역 중 Text영역이 가장 낮은 주소(0에 가까운 주소), Data영역이 그 다음 주소, Heap영역이 Data영역의 다음 주소, Stack영역은 4개 영역 중 가장 높은 주소에 위치함</li>
            </div>
            <div class="post_subheading">코드 예시</div>
            <img src="{% static 'img/sourcecode/post8-4.png' %}" class="mb-6">
            <div class="post_text">
                <p class="font-bold">< 64bit 운영체제 컴파일 결과 ></64bit></p>
                <img src="{% static 'img/sourcecode/post8-5.png' %}" class="w-1/2">
                <li>상수의 메모리 주소값인 0x100000e64는 실질적으로 0x0000000100000e64을 의미함</li>
                <li><span class="font-bold">상수</span> : Text영역 → 다른 변수들과 비교했을 때 가장 낮은주소에 위치함</li>
                <li>전역변수 : </li>
                <div class="ml-7">
                    <p>a. Data 영역 → 상수보다는 높은 주소에, Heap영역인 동적할당변수보다는 낮은주소에 위치함</p>
                    <p>b. 초기화 된 변수들이 더 낮은주소에 위치하고 모두 메모리에 올려지면 그 다음으로 초기화가 안된 변수들이 할당됨</p>
                </div>
                <li><span class="font-bold">정적변수</span> :</li>
                <div class="ml-7">
                    <p>a. Data영역 → 상수 영역에 있는 데이터보단 높은 주소에, Heap영역에 있는 데이터 주소보단 낮은 주소에 자리함</p>
                </div>
                <li><span class="font-bold">함수</span> :</li>
                <div class="ml-7">
                    <p>a. 상수와 마찬가지로 Text영역 → Data 영역보다 낮은 주소에 위치함</p>
                    <p>b. Text영역에 있는 함수를 호출함과 동시에 내부에 있는 변수들은 Stack영역에 할당됨</p>
                    <p>c. 그리고 해당 함수가 종료되면 Stack메모리에 있던 함수의 변수들은 모두 pop됨</p>
                </div>
                <li><span class="font-bold">지역변수</span> :</li>
                <div class="ml-7">
                    <p>a.  Stack영역</p>
                    <p>b. Stack영역은 다른 영역과는 다르게 높은주소에서 낮은 주소로 메모리에 할당됨</p>
                    <p>c. 즉, 어느정도 높은 주소부터 시작하여 지역변수들이 선언될 때마다 낮은주소로 쌓임</p>
                    <p class="ml-5">⇒ 먼저 선언한 지역변수1은 0x7ffeefbff47c 이고, 그 다음으로 선언된 지역변수2는 int형 변수이므로 4byte의 크기이니 4칸만큼 작은 주소인 0x7ffeefbff478에 위치함</p>
                </div>
                <li><span class="font-bold">동적할당 변수</span> :</li>
                <div class="ml-7">
                    <p>a. Heap영역 → Text, Data보다는 비교적 높은 주소에서 시작하지만, Stack영역에 비해서는 한없이 작은 주소에서 시작함</p>
                </div>
            </div>
        </div>
        <div id="BufferOverflow">
            <div class="post_heading">Buffer Overflow</div>
            <div class="post_text">
                <li>버퍼(buffer)를 넘치게(overflow)하게 되는 상태를 말하며, 여기서 버퍼는 보통 메모리를 의미함</li>
                <li>또 다른 말로는 Buffer Overrun이라고도 함</li>
                <li>메모리에서 프로그램이 실행하면서 생성되는 데이터들이 저장되는 대표적인 Heap과 Stack영역에서 해당 버퍼를 인위적으로 넘치게 만들면 인접한 영역까지 침범하게 만들고 결국 포인터 영역까지 침범하게 됨 → 특정 명령을 넣어 프로그램을 붕괴시키거나 시스템의 권한을 상승시킬 수 있음</li>
                <li>물론 영역 간의 침범만이 Overflow인 것은 아님 → 메모리에서 할당된 변수의 크기보다 더 큰 데이터를 입력시키는 경우도 Overflow임</li>
                <p class="ml-7">⇒ 대표적으로 C언어에서 데이터의 크기를 검사하지 않는 strcpy(), gets(), scanf()가 있음</p>
                <li>즉, Overflow라는 큰 범주 안에 Heap Overflow, Stack Overflow가 있으며, 그 안에서도 데이터 버퍼의 Overflow 메모리 영역에 대한 Overflow가 있음</li>
                <li>어떤 개발도구를 사용하고, 어떤 언어를 사용하느냐에 따라 에러 메세지가 조금씩 다를 수 있고, 어떨때는 그냥 프로그램을 중단시켜버릴 수도 있음</li>
            </div>
            <div class="post_subheading">Stack Overflow</div>
            <div class="post_text">
                <li>호출 스택이 할당된 스택 영역 경계선 밖으로 넘어갈 때 발생함</li>
                <p class="ml-7">⇒ '재귀호출'에서 가장 흔히 발생함</p>
                <li>아래와 같이 탈출 없이 계속해서 호출되는 재귀함수의 경우 무한히 stack 영역에 데이터가 push되다가 Stack영역을 넘어가버리게 되면 바로 Stack Overflow가 발생</li>
                <img src="{% static 'img/sourcecode/post8-6.png' %}" class="mb-1">
                <img src="{% static 'img/sourcecode/post8-7.png' %}" class="mb-1">
                <img src="{% static 'img/sourcecode/post8-8.png' %}">
            </div>
            <div class="post_subheading">Heap Overflow</div>
            <div class="post_text">
                <li>Stack Overflow는 힙 영역에서 할당된 영역의 경계선 밖으로 넘어갈 때 발생</li>
                <p class="ml-7">⇒ 가장 흔히 발생하는 경우는 매우 큰 데이터를 생성하려고 할 때 발생</p>
                <li>마찬가지로 Heap영역보다 큰 데이터가 들어올 경우 발생</li>
                <p class="ml-7">⇒ Stack에서는 지역변수들이 스택에 쌓인다면, 반대로 Heap 영역에서는 동적으로 관리되는 데이터들이 일정 공간 이상 차지하게 될 경우 발생</p>
                <li>Heap에서 관리하는 데이터 종류 : malloc()같은 동적 할당 함수, 객체, 참조변수</li>
            </div>
            <img src="{% static 'img/sourcecode/post8-9.png' %}" class="-mt-3">
            <div class="post_text">
                <p>a. 대표적으로 C 언어에서는 new 연산자가 없음</p>
                <p>b. int[] 같은 배열의 경우 전역, 정적변수가 아닌이상 Stack 영역에 쌓임</p>
                <p>c. 동적할당을 하고 싶은 경우 malloc() 같은 함수 사용</p>
                <p>d. 반대로 C++나 Java같은 경우는 new연산자를 지원하고 있어 하나의 객체로 Heap영역에서 관리됨</p> 
            </div>
            <img src="{% static 'img/sourcecode/post8-10.png' %}">
            <div class="post_text">
                <p class="ml-7">⇒ 예를 들어 Heap 영역을 벗어나는 아주아주 큰 배열을 생성할 경우 위와 같이 Overflow 발생</p>
            </div>
        </div>
    </main>
{% endblock post_content %}